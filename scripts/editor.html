<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¹´í”¼ë°”ë¼ í•˜ì´ë¸Œë¦¬ë“œ ë ˆë²¨ ì—ë””í„°</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #222; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; background: #333; padding: 20px; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid #444; overflow-y: auto; }
        .main-area { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #1a1a1a; overflow: auto; }
        
        h2 { margin: 0 0 10px 0; color: #4CAF50; font-size: 18px; }
        label { display: block; font-size: 13px; color: #ccc; margin-bottom: 5px; }
        input[type="file"] { width: 100%; background: #444; padding: 5px; border-radius: 4px; color: white; font-size: 12px; }
        
        /* ë¹„êµ ìŠ¬ë¼ì´ë” */
        .slider-container { background: #444; padding: 10px; border-radius: 8px; text-align: center; }
        input[type="range"] { width: 100%; cursor: pointer; }

        /* ìº”ë²„ìŠ¤ */
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: crosshair; }

        /* ë°ì´í„° ì˜ì—­ */
        textarea { width: 100%; height: 150px; background: #222; color: #0f0; border: 1px solid #444; font-family: monospace; font-size: 11px; resize: vertical; }
        
        .btn { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-green:hover { background: #45a049; }
        .btn-red { background: #ff5252; color: white; margin-top: 5px; }
        .btn-red:hover { background: #ff1744; }

        .info-box { background: #444; padding: 10px; border-radius: 4px; font-size: 12px; line-height: 1.4; color: #ddd; }
        .highlight { color: #4CAF50; font-weight: bold; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ› ï¸ ë ˆë²¨ ì—ë””í„°</h2>
    
    <div class="info-box">
        1. <b>ì›ë³¸</b>ê³¼ <b>í‹€ë¦°ê·¸ë¦¼</b>ì„ ëª¨ë‘ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.<br>
        2. íŒŒì´ì¬ì´ ë§Œë“  <b>JSON</b>ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš” (ì„ íƒ).<br>
        3. <b>ìŠ¬ë¼ì´ë”</b>ë¥¼ ì›€ì§ì—¬ ë¹„êµí•˜ì„¸ìš”.<br>
        4. ë°•ìŠ¤ë¥¼ í´ë¦­í•´ <b>ì„ íƒ/ì‚­ì œ</b>í•˜ê±°ë‚˜, ë“œë˜ê·¸í•´ì„œ <b>ì¶”ê°€</b>í•˜ì„¸ìš”.
    </div>

    <div>
        <label>1. ì›ë³¸ ì´ë¯¸ì§€ (Original)</label>
        <input type="file" id="imgOriginal" accept="image/*">
    </div>
    <div>
        <label>2. í‹€ë¦°ê·¸ë¦¼ ì´ë¯¸ì§€ (Modified)</label>
        <input type="file" id="imgModified" accept="image/*">
    </div>
    <div>
        <label>3. íŒŒì´ì¬ ìƒì„± JSON (Draft)</label>
        <input type="file" id="jsonLoader" accept=".json">
    </div>

    <div class="slider-container">
        <label>ğŸ‘€ ì´ë¯¸ì§€ ë¹„êµ (íˆ¬ëª…ë„)</label>
        <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="1">
        <div style="font-size: 11px; margin-top: 5px; display:flex; justify-content:space-between;">
            <span>ì›ë³¸</span>
            <span>í‹€ë¦°ê·¸ë¦¼</span>
        </div>
    </div>

    <div style="margin-top: auto;">
        <label>ìµœì¢… ë°ì´í„°</label>
        <textarea id="jsonOutput" readonly></textarea>
        <button class="btn btn-green" onclick="copyJson()">ğŸ“‹ JSON ë³µì‚¬í•˜ê¸°</button>
        <button class="btn btn-red" onclick="deleteSelected()">ğŸ—‘ï¸ ì„ íƒëœ ë°•ìŠ¤ ì‚­ì œ (Del)</button>
    </div>
</div>

<div class="main-area">
    <canvas id="editorCanvas"></canvas>
</div>

<script>
    const canvas = document.getElementById('editorCanvas');
    const ctx = canvas.getContext('2d');
    const slider = document.getElementById('opacitySlider');
    const jsonOutput = document.getElementById('jsonOutput');

    let imgOrg = new Image();
    let imgMod = new Image();
    let imgOrgLoaded = false;
    let imgModLoaded = false;

    // ë°ì´í„° ê´€ë¦¬
    let spots = [];
    let selectedSpotIndex = -1;

    // ë“œë˜ê·¸ ìƒíƒœ
    let isDrawing = false;
    let startX, startY;

    // ==========================================
    // 1. íŒŒì¼ ë¡œë“œ í•¸ë“¤ëŸ¬
    // ==========================================
    document.getElementById('imgOriginal').addEventListener('change', (e) => loadImg(e, imgOrg, () => { imgOrgLoaded = true; render(); }));
    document.getElementById('imgModified').addEventListener('change', (e) => loadImg(e, imgMod, () => { imgModLoaded = true; render(); }));
    
    document.getElementById('jsonLoader').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const loadedSpots = JSON.parse(event.target.result);
                // ê¸°ì¡´ ë°ì´í„° í¬ë§· í˜¸í™˜ì„± ì²˜ë¦¬
                spots = loadedSpots.map((s, i) => ({
                    id: i + 1,
                    x: s.x, y: s.y, width: s.width, height: s.height
                }));
                render();
                updateOutput();
                alert(`âœ… ${spots.length}ê°œì˜ ë°•ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
            } catch (err) {
                alert("JSON íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        };
        reader.readAsText(e.target.files[0]);
    });

    function loadImg(e, imgObj, callback) {
        const reader = new FileReader();
        reader.onload = (event) => {
            imgObj.onload = () => {
                // ì²« ì´ë¯¸ì§€ ë¡œë“œ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ë§ì¶¤
                if (canvas.width === 300) { // ê¸°ë³¸ê°’ì¼ ë•Œ
                    canvas.width = imgObj.width;
                    canvas.height = imgObj.height;
                }
                callback();
            }
            imgObj.src = event.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
    }

    // ==========================================
    // 2. ë Œë”ë§ (í•µì‹¬: ì´ë¯¸ì§€ ê²¹ì¹˜ê¸°)
    // ==========================================
    slider.addEventListener('input', render);

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. ì›ë³¸ ê·¸ë¦¬ê¸°
        if (imgOrgLoaded) {
            ctx.globalAlpha = 1.0;
            ctx.drawImage(imgOrg, 0, 0);
        }

        // 2. í‹€ë¦°ê·¸ë¦¼ ê²¹ì³ ê·¸ë¦¬ê¸° (íˆ¬ëª…ë„ ì ìš©)
        if (imgModLoaded) {
            ctx.globalAlpha = slider.value;
            ctx.drawImage(imgMod, 0, 0);
        }

        // 3. ë°•ìŠ¤ ê·¸ë¦¬ê¸°
        ctx.globalAlpha = 1.0;
        spots.forEach((spot, index) => {
            const isSelected = index === selectedSpotIndex;
            
            // ë°•ìŠ¤ ë‚´ë¶€ (ë°˜íˆ¬ëª…)
            ctx.fillStyle = isSelected ? "rgba(255, 0, 0, 0.3)" : "rgba(0, 255, 0, 0.2)";
            ctx.fillRect(spot.x, spot.y, spot.width, spot.height);

            // í…Œë‘ë¦¬
            ctx.strokeStyle = isSelected ? "#FF0000" : "#00FF00";
            ctx.lineWidth = isSelected ? 3 : 2;
            ctx.strokeRect(spot.x, spot.y, spot.width, spot.height);

            // ë²ˆí˜¸
            ctx.fillStyle = "white";
            ctx.font = "bold 14px Arial";
            ctx.shadowColor="black";
            ctx.shadowBlur=3;
            ctx.fillText(index + 1, spot.x, spot.y - 5);
            ctx.shadowBlur=0;
        });
    }

    // ==========================================
    // 3. ì¸í„°ë™ì…˜ (ê·¸ë¦¬ê¸°, ì„ íƒ)
    // ==========================================
    canvas.addEventListener('mousedown', (e) => {
        const { x, y } = getMousePos(e);
        
        // í´ë¦­í•œ ê³³ì— ë°•ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸ (ì„ íƒ ëª¨ë“œ)
        const clickedIndex = spots.findIndex(s => 
            x >= s.x && x <= s.x + s.width && y >= s.y && y <= s.y + s.height
        );

        if (clickedIndex !== -1) {
            // ë°•ìŠ¤ë¥¼ ì„ íƒí•¨
            selectedSpotIndex = clickedIndex;
            render();
            return; // ê·¸ë¦¬ê¸° ëª¨ë“œ ì§„ì… ì•ˆ í•¨
        }

        // ë¹ˆ ê³³ì„ í´ë¦­í•¨ -> ê·¸ë¦¬ê¸° ëª¨ë“œ ì‹œì‘
        selectedSpotIndex = -1; // ì„ íƒ í•´ì œ
        isDrawing = true;
        startX = x;
        startY = y;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const { x, y } = getMousePos(e);
        render(); // ê¸°ì¡´ í™”ë©´ ë³µêµ¬
        
        // í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ ë°•ìŠ¤ ë¯¸ë¦¬ë³´ê¸° (ë¹¨ê°• ì ì„ )
        const w = x - startX;
        const h = y - startY;
        ctx.strokeStyle = "yellow";
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(startX, startY, w, h);
        ctx.setLineDash([]);
    });

    canvas.addEventListener('mouseup', (e) => {
        if (!isDrawing) return;
        isDrawing = false;
        
        const { x, y } = getMousePos(e);
        let w = x - startX;
        let h = y - startY;

        // ì—­ë°©í–¥ ë“œë˜ê·¸ ì²˜ë¦¬
        let finalX = w < 0 ? x : startX;
        let finalY = h < 0 ? y : startY;
        let finalW = Math.abs(w);
        let finalH = Math.abs(h);

        if (finalW > 10 && finalH > 10) {
            addSpot(finalX, finalY, finalW, finalH);
        }
        render();
    });

    // í‚¤ë³´ë“œ ì‚­ì œ (Delete í‚¤)
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Delete' || e.key === 'Backspace') {
            deleteSelected();
        }
    });

    function getMousePos(evt) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: (evt.clientX - rect.left), // ìº”ë²„ìŠ¤ ìŠ¤ì¼€ì¼ë§ ê³ ë ¤ ì•ˆ í•¨ (1:1 ê°€ì •)
            y: (evt.clientY - rect.top)
        };
    }

    // ==========================================
    // 4. ë°ì´í„° ë¡œì§
    // ==========================================
    function addSpot(x, y, w, h) {
        spots.push({
            id: spots.length + 1,
            x: Math.round(x),
            y: Math.round(y),
            width: Math.round(w),
            height: Math.round(h)
        });
        selectedSpotIndex = spots.length - 1; // ë°©ê¸ˆ ë§Œë“ ê±° ì„ íƒ
        updateOutput();
    }

    function deleteSelected() {
        if (selectedSpotIndex === -1) return;
        spots.splice(selectedSpotIndex, 1);
        selectedSpotIndex = -1;
        updateOutput();
        render();
    }

    function updateOutput() {
        // ìµœì¢… ì•±ìš© ë°ì´í„° í¬ë§·ìœ¼ë¡œ ë³€í™˜ ë° ê³„ì‚°
        const finalData = spots.map((s, index) => {
            const centerX = s.x + s.width / 2;
            const centerY = s.y + s.height / 2;
            const imgW = canvas.width;
            const imgH = canvas.height;

            return {
                id: index + 1,
                x: s.x,
                y: s.y,
                width: s.width,
                height: s.height,
                center_x: Math.round(centerX),
                center_y: Math.round(centerY),
                relative_x: Number((centerX / imgW).toFixed(4)),
                relative_y: Number((centerY / imgH).toFixed(4)),
                relative_radius: Number((Math.max(s.width, s.height) / 2 / imgW).toFixed(4))
            };
        });
        
        jsonOutput.value = JSON.stringify(finalData, null, 2);
    }

    function copyJson() {
        jsonOutput.select();
        document.execCommand('copy');
        alert("JSONì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
</script>
</body>
</html>

