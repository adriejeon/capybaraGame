<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìˆ¨ì€ê·¸ë¦¼ì°¾ê¸° íˆíŠ¸ë°•ìŠ¤ ì—ë””í„°</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #222; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; background: #333; padding: 20px; display: flex; flex-direction: column; gap: 15px; border-right: 1px solid #444; overflow-y: auto; }
        .main-area { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #1a1a1a; overflow: auto; }
        
        h2 { margin: 0 0 10px 0; color: #9C27B0; font-size: 18px; }
        label { display: block; font-size: 13px; color: #ccc; margin-bottom: 5px; }
        input[type="file"] { width: 100%; background: #444; padding: 5px; border-radius: 4px; color: white; font-size: 12px; }
        
        /* ìº”ë²„ìŠ¤ */
        canvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: crosshair; }

        /* ë°ì´í„° ì˜ì—­ */
        textarea { width: 100%; height: 150px; background: #222; color: #0f0; border: 1px solid #444; font-family: monospace; font-size: 11px; resize: vertical; }
        
        .btn { padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-green:hover { background: #45a049; }
        .btn-purple { background: #9C27B0; color: white; margin-top: 5px; }
        .btn-purple:hover { background: #7B1FA2; }
        .btn-red { background: #ff5252; color: white; margin-top: 5px; }
        .btn-red:hover { background: #ff1744; }

        .info-box { background: #444; padding: 10px; border-radius: 4px; font-size: 12px; line-height: 1.4; color: #ddd; }
        .highlight { color: #9C27B0; font-weight: bold; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>ğŸ¨ ìˆ¨ì€ê·¸ë¦¼ì°¾ê¸° ì—ë””í„°</h2>
    
    <div class="info-box">
        1. <b>ì´ë¯¸ì§€</b>ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.<br>
        2. ê¸°ì¡´ <b>JSON</b>ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš” (ì„ íƒ).<br>
        3. ë“œë˜ê·¸í•´ì„œ íˆíŠ¸ë°•ìŠ¤ë¥¼ <b>ì¶”ê°€</b>í•˜ì„¸ìš”.<br>
        4. ë°•ìŠ¤ë¥¼ í´ë¦­í•´ <b>ì„ íƒ/ì‚­ì œ</b>í•˜ì„¸ìš”.<br>
        5. <b>JSON ì €ì¥í•˜ê¸°</b> ë²„íŠ¼ìœ¼ë¡œ íŒŒì¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.
    </div>

    <div>
        <label>1. ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input type="file" id="imgFile" accept="image/*">
    </div>
    <div>
        <label>2. ê¸°ì¡´ JSON ë¶ˆëŸ¬ì˜¤ê¸° (ì„ íƒ)</label>
        <input type="file" id="jsonLoader" accept=".json">
    </div>

    <div style="margin-top: auto;">
        <label>ìµœì¢… ë°ì´í„°</label>
        <textarea id="jsonOutput" readonly></textarea>
        <button class="btn btn-green" onclick="copyJson()">ğŸ“‹ JSON ë³µì‚¬í•˜ê¸°</button>
        <button class="btn btn-purple" onclick="saveJson()">ğŸ’¾ JSON ì €ì¥í•˜ê¸°</button>
        <button class="btn btn-red" onclick="deleteSelected()">ğŸ—‘ï¸ ì„ íƒëœ ë°•ìŠ¤ ì‚­ì œ (Del)</button>
        <button class="btn btn-red" onclick="clearAllSpots()">ğŸ—‘ï¸ ëª¨ë“  íˆíŠ¸ë°•ìŠ¤ ì§€ìš°ê¸°</button>
    </div>
</div>

<div class="main-area">
    <canvas id="editorCanvas"></canvas>
</div>

<script>
    const canvas = document.getElementById('editorCanvas');
    const ctx = canvas.getContext('2d');
    const jsonOutput = document.getElementById('jsonOutput');

    let img = new Image();
    let imgLoaded = false;
    let currentFileName = ''; // í˜„ì¬ ì´ë¯¸ì§€ íŒŒì¼ëª… (ì˜ˆ: "1-stage.png")

    // ë°ì´í„° ê´€ë¦¬
    let spots = [];
    let selectedSpotIndex = -1;

    // ë“œë˜ê·¸ ìƒíƒœ
    let isDrawing = false;
    let startX, startY;

    // ==========================================
    // 1. íŒŒì¼ ë¡œë“œ í•¸ë“¤ëŸ¬
    // ==========================================
    document.getElementById('imgFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // íŒŒì¼ëª… ì €ì¥ (í™•ì¥ì ì œê±°)
        currentFileName = file.name.replace(/\.[^/.]+$/, "");
        
        // ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ê¸°ì¡´ íˆíŠ¸ë°•ìŠ¤ ì´ˆê¸°í™”
        spots = [];
        selectedSpotIndex = -1;
        updateOutput();
        
        loadImg(e, img, () => { 
            imgLoaded = true; 
            render(); 
            console.log('ìƒˆ ì´ë¯¸ì§€ ë¡œë“œë¨. íˆíŠ¸ë°•ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ.');
        });
    });
    
    document.getElementById('jsonLoader').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const loadedSpots = JSON.parse(event.target.result);
                spots = loadedSpots.map((s, i) => ({
                    id: i + 1,
                    x: s.x, y: s.y, width: s.width, height: s.height
                }));
                render();
                updateOutput();
                alert(`âœ… ${spots.length}ê°œì˜ ë°•ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
            } catch (err) {
                alert("JSON íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        };
        reader.readAsText(e.target.files[0]);
    });

    function loadImg(e, imgObj, callback) {
        const reader = new FileReader();
        reader.onload = (event) => {
            imgObj.onload = () => {
                // ì²« ì´ë¯¸ì§€ ë¡œë“œ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ë§ì¶¤
                canvas.width = imgObj.width;
                canvas.height = imgObj.height;
                callback();
            }
            imgObj.src = event.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
    }

    // ==========================================
    // 2. ë Œë”ë§
    // ==========================================
    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
        if (imgLoaded) {
            ctx.globalAlpha = 1.0;
            ctx.drawImage(img, 0, 0);
        }

        // 2. ë°•ìŠ¤ ê·¸ë¦¬ê¸°
        ctx.globalAlpha = 1.0;
        spots.forEach((spot, index) => {
            const isSelected = index === selectedSpotIndex;
            
            // ë°•ìŠ¤ ë‚´ë¶€ (ë°˜íˆ¬ëª…)
            ctx.fillStyle = isSelected ? "rgba(255, 0, 0, 0.3)" : "rgba(156, 39, 176, 0.2)";
            ctx.fillRect(spot.x, spot.y, spot.width, spot.height);

            // í…Œë‘ë¦¬
            ctx.strokeStyle = isSelected ? "#FF0000" : "#9C27B0";
            ctx.lineWidth = isSelected ? 3 : 2;
            ctx.strokeRect(spot.x, spot.y, spot.width, spot.height);

            // ë²ˆí˜¸
            ctx.fillStyle = "white";
            ctx.font = "bold 14px Arial";
            ctx.shadowColor="black";
            ctx.shadowBlur=3;
            ctx.fillText(index + 1, spot.x, spot.y - 5);
            ctx.shadowBlur=0;
        });
    }

    // ==========================================
    // 3. ì¸í„°ë™ì…˜ (ê·¸ë¦¬ê¸°, ì„ íƒ)
    // ==========================================
    canvas.addEventListener('mousedown', (e) => {
        const { x, y } = getMousePos(e);
        
        // í´ë¦­í•œ ê³³ì— ë°•ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸ (ì„ íƒ ëª¨ë“œ)
        const clickedIndex = spots.findIndex(s => 
            x >= s.x && x <= s.x + s.width && y >= s.y && y <= s.y + s.height
        );

        if (clickedIndex !== -1) {
            // ë°•ìŠ¤ë¥¼ ì„ íƒí•¨
            selectedSpotIndex = clickedIndex;
            render();
            return;
        }

        // ë¹ˆ ê³³ì„ í´ë¦­í•¨ -> ê·¸ë¦¬ê¸° ëª¨ë“œ ì‹œì‘
        selectedSpotIndex = -1;
        isDrawing = true;
        startX = x;
        startY = y;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const { x, y } = getMousePos(e);
        render();
        
        // í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ ë°•ìŠ¤ ë¯¸ë¦¬ë³´ê¸°
        const w = x - startX;
        const h = y - startY;
        ctx.strokeStyle = "yellow";
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(startX, startY, w, h);
        ctx.setLineDash([]);
    });

    canvas.addEventListener('mouseup', (e) => {
        if (!isDrawing) return;
        isDrawing = false;
        
        const { x, y } = getMousePos(e);
        let w = x - startX;
        let h = y - startY;

        // ì—­ë°©í–¥ ë“œë˜ê·¸ ì²˜ë¦¬
        let finalX = w < 0 ? x : startX;
        let finalY = h < 0 ? y : startY;
        let finalW = Math.abs(w);
        let finalH = Math.abs(h);

        if (finalW > 10 && finalH > 10) {
            addSpot(finalX, finalY, finalW, finalH);
        }
        render();
    });

    // í‚¤ë³´ë“œ ì‚­ì œ
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Delete' || e.key === 'Backspace') {
            deleteSelected();
        }
    });

    function getMousePos(evt) {
        const rect = canvas.getBoundingClientRect();
        return {
            x: (evt.clientX - rect.left),
            y: (evt.clientY - rect.top)
        };
    }

    // ==========================================
    // 4. ë°ì´í„° ë¡œì§
    // ==========================================
    function addSpot(x, y, w, h) {
        spots.push({
            id: spots.length + 1,
            x: Math.round(x),
            y: Math.round(y),
            width: Math.round(w),
            height: Math.round(h)
        });
        selectedSpotIndex = spots.length - 1;
        updateOutput();
    }

    function deleteSelected() {
        if (selectedSpotIndex === -1) return;
        spots.splice(selectedSpotIndex, 1);
        selectedSpotIndex = -1;
        updateOutput();
        render();
    }

    function clearAllSpots() {
        if (spots.length === 0) {
            alert("ì§€ìš¸ íˆíŠ¸ë°•ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        const confirmed = confirm(`ì •ë§ë¡œ ëª¨ë“  íˆíŠ¸ë°•ìŠ¤(${spots.length}ê°œ)ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (!confirmed) return;
        
        spots = [];
        selectedSpotIndex = -1;
        updateOutput();
        render();
        alert("âœ… ëª¨ë“  íˆíŠ¸ë°•ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    function updateOutput() {
        // ìµœì¢… ì•±ìš© ë°ì´í„° í¬ë§·ìœ¼ë¡œ ë³€í™˜
        const finalData = spots.map((s, index) => {
            const centerX = s.x + s.width / 2;
            const centerY = s.y + s.height / 2;
            const imgW = canvas.width;
            const imgH = canvas.height;

            return {
                id: index + 1,
                x: s.x,
                y: s.y,
                width: s.width,
                height: s.height,
                center_x: Math.round(centerX),
                center_y: Math.round(centerY),
                relative_x: Number((centerX / imgW).toFixed(4)),
                relative_y: Number((centerY / imgH).toFixed(4)),
                relative_radius: Number((Math.max(s.width, s.height) / 2 / imgW).toFixed(4))
            };
        });
        
        jsonOutput.value = JSON.stringify(finalData, null, 2);
    }

    function copyJson() {
        jsonOutput.select();
        document.execCommand('copy');
        alert("JSONì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    function saveJson() {
        if (!currentFileName) {
            alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”!");
            return;
        }
        
        if (spots.length === 0) {
            alert("ì €ì¥í•  íˆíŠ¸ë°•ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }

        const jsonData = jsonOutput.value;
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentFileName}.json`; // ì´ë¯¸ì§€ íŒŒì¼ëª…ê³¼ ë™ì¼í•œ ì´ë¦„ìœ¼ë¡œ ì €ì¥
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`âœ… ${currentFileName}.json íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\níŒŒì¼ì„ assets/hidden_json/ í´ë”ì— ì €ì¥í•˜ì„¸ìš”.`);
    }
</script>
</body>
</html>
