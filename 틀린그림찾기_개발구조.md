# 틀린그림찾기 게임 개발 구조 설명

## 📁 파일 구조

```
lib/
├── ui/screens/
│   └── spot_difference_screen.dart    # 게임 화면 UI 및 로직
├── game/models/
│   └── spot_difference_data.dart      # 스팟 데이터 및 스테이지 관리
└── data/
    └── ticket_manager.dart             # 뽑기권 관리 (게임 완료 시 획득)

assets/
└── soptTheDifference/                  # 이미지 파일들
    ├── 1-1.png                         # 원본 이미지
    ├── 1-1-wrong.png                   # 틀린그림 이미지
    ├── 1-2.png, 1-2-wrong.png
    └── ... (레벨별로 1-1 ~ 5-7까지)
```

---

## 🎯 핵심 개념

### 1. **스팟(Spot) 좌표 시스템**

틀린그림찾기는 **비율 좌표 시스템**을 사용합니다:

```dart
class DifferenceSpot {
  final double x;      // 0.0 ~ 1.0 (이미지 너비 기준 비율)
  final double y;      // 0.0 ~ 1.0 (이미지 높이 기준 비율)
  final double radius; // 0.0 ~ 1.0 (터치 허용 반경, 이미지 너비 기준)
}
```

**예시:**
- `x: 0.5, y: 0.5` → 이미지 정중앙
- `x: 0.25, y: 0.30` → 이미지 왼쪽 위쪽 영역
- `radius: 0.10` → 이미지 너비의 10% 반경 내 터치 허용

### 2. **터치 감지 로직**

```dart
void _onImageTapped(Offset tapPosition, Size imageSize, bool isOriginal) {
  // 1. 터치 위치를 비율 좌표로 변환
  final relativeX = tapPosition.dx / imageSize.width;
  final relativeY = tapPosition.dy / imageSize.height;
  
  // 2. 각 스팟과의 거리 계산
  for (int i = 0; i < _currentStage!.spots.length; i++) {
    final spot = _currentStage!.spots[i];
    final distance = _calculateDistance(relativeX, relativeY, spot.x, spot.y);
    
    // 3. 거리가 반경 이내인지 확인 (제곱 거리 vs 제곱 반경 비교)
    if (distance <= spot.radius * spot.radius) {
      // 정답! 스팟 발견
      _foundSpots[i] = true;
    }
  }
}

double _calculateDistance(double x1, double y1, double x2, double y2) {
  // 유클리드 거리의 제곱 반환
  return ((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));
}
```

**중요:** `_calculateDistance`는 **제곱 거리**를 반환하므로, `spot.radius`와 비교할 때도 **제곱**해서 비교해야 합니다.

---

## 📊 데이터 구조

### **SpotDifferenceStage** (스테이지 정보)

```dart
class SpotDifferenceStage {
  final int level;                    // 레벨 (1~5)
  final int stage;                   // 스테이지 번호 (1~7)
  final String originalImage;         // 원본 이미지 경로
  final String wrongImage;            // 틀린그림 이미지 경로
  final List<DifferenceSpot> spots;   // 틀린 부분 위치들
  final int timeLimit;                // 시간 제한 (초)
  final int spotCount;                // 찾아야 할 틀린그림 개수
}
```

### **레벨별 설정**

| 레벨 | 스테이지 수 | 시간 제한 | 스팟 개수 | 반경 |
|------|------------|----------|----------|------|
| 1 (아기) | 7개 | 60초 | 3개 | 0.10 |
| 2 (어린이) | 6개 | 50초 | 4개 | 0.08 |
| 3 (청소년) | 6개 | 45초 | 5개 | 0.07 |
| 4 (어른) | 6개 | 40초 | 5개 | 0.06 |
| 5 (신의 경지) | 7개 | 35초 | 6개 | 0.05 |

---

## 🔧 스팟 설정 방법

### 현재 상태

`spot_difference_data.dart` 파일의 `_spotData` 맵에 **임의로 설정된 placeholder 스팟**들이 있습니다:

```dart
static final Map<String, List<DifferenceSpot>> _spotData = {
  '1-1': [
    const DifferenceSpot(x: 0.25, y: 0.30, radius: 0.10),
    const DifferenceSpot(x: 0.70, y: 0.50, radius: 0.10),
    const DifferenceSpot(x: 0.45, y: 0.75, radius: 0.10),
  ],
  // ... 다른 스테이지들
};
```

### ⚠️ 문제점

**현재 스팟 위치는 임의로 설정되어 있어서, 실제 이미지의 틀린 부분과 일치하지 않습니다!**

### ✅ 해결 방법

1. **이미지 확인**: 각 스테이지의 원본 이미지(`1-1.png`)와 틀린그림(`1-1-wrong.png`)을 비교
2. **스팟 위치 측정**: 
   - 이미지 편집 도구(예: Photoshop, GIMP)에서 틀린 부분의 픽셀 좌표 확인
   - 비율 좌표로 변환: `x = 픽셀X / 이미지너비`, `y = 픽셀Y / 이미지높이`
3. **반경 조정**: 
   - 작은 차이 → `radius: 0.05 ~ 0.06`
   - 중간 차이 → `radius: 0.08 ~ 0.10`
   - 큰 차이 → `radius: 0.12 ~ 0.15`

### 📝 스팟 설정 예시

```dart
'1-1': [
  // 예: 왼쪽 위 모서리 근처에 틀린 부분이 있다면
  const DifferenceSpot(x: 0.15, y: 0.20, radius: 0.08),
  
  // 예: 오른쪽 중앙에 틀린 부분이 있다면
  const DifferenceSpot(x: 0.80, y: 0.50, radius: 0.10),
  
  // 예: 아래쪽 중앙에 틀린 부분이 있다면
  const DifferenceSpot(x: 0.50, y: 0.85, radius: 0.08),
],
```

---

## 🎮 게임 플로우

```
1. 게임 시작
   ↓
2. SpotDifferenceDataManager에서 랜덤 스테이지 로드
   ↓
3. 이미지 표시 (원본 위, 틀린그림 아래)
   ↓
4. 사용자가 이미지 터치
   ↓
5. _onImageTapped() 호출
   - 터치 위치를 비율 좌표로 변환
   - 각 스팟과의 거리 계산
   - 반경 이내면 정답 처리
   ↓
6. 모든 스팟 발견 시 게임 완료
   ↓
7. 전면 광고 표시
   ↓
8. 뽑기권 획득 (하루 최대 3회)
```

---

## 🐛 디버깅 팁

### 1. 콘솔 로그 확인

터치할 때마다 콘솔에 다음 정보가 출력됩니다:

```
[SpotDifference] 터치: (0.45, 0.30)
[SpotDifference] 스팟 0 발견! (터치: 0.45, 0.30, 스팟: 0.25, 0.30, 거리: 0.20, 반경: 0.10)
```

### 2. 힌트 기능 활용

힌트 버튼을 누르면 아직 찾지 못한 스팟 위치에 **주황색 원**이 2초간 표시됩니다. 이를 통해 실제 스팟 위치를 확인할 수 있습니다.

### 3. 스팟 마커 확인

정답을 맞추면 **초록색 체크 표시**가 해당 위치에 나타납니다. 이를 통해 스팟 위치가 올바른지 확인할 수 있습니다.

---

## 🔍 현재 발견된 버그 및 수정 사항

### ✅ 수정 완료: 터치 감지 로직 버그

**문제:**
- `_calculateDistance()`가 제곱 거리를 반환하는데, `spot.radius`와 직접 비교하고 있었음
- 단위가 맞지 않아 터치 감지가 제대로 작동하지 않음

**수정:**
```dart
// 수정 전
if (distance <= spot.radius) { ... }

// 수정 후
if (distance <= spot.radius * spot.radius) { ... }
```

---

## 📝 다음 단계

1. **실제 이미지 확인**: 각 스테이지의 이미지를 열어서 틀린 부분 확인
2. **스팟 좌표 수정**: `spot_difference_data.dart`의 `_spotData` 맵에서 각 스테이지의 스팟 좌표를 실제 틀린 부분 위치로 수정
3. **반경 조정**: 각 스팟의 `radius` 값을 적절히 조정 (너무 크면 쉬워지고, 너무 작으면 어려워짐)
4. **테스트**: 각 스테이지를 플레이하면서 스팟 위치가 정확한지 확인

---

## 💡 추가 개선 아이디어

1. **스팟 시각화 도구**: 개발 모드에서 실제 스팟 위치를 이미지 위에 표시하는 디버그 모드
2. **스팟 편집 화면**: 앱 내에서 스팟 위치를 직접 조정할 수 있는 관리자 화면
3. **자동 스팟 감지**: 이미지 비교 알고리즘을 사용하여 자동으로 틀린 부분 감지 (고급)


